f047b283a scripts/generate/genesis.sh:  some more order in the business
diff --git a/scripts/generate/genesis.sh b/scripts/generate/genesis.sh
index 7d2d08846..ac55a5b09 100755
--- a/scripts/generate/genesis.sh
+++ b/scripts/generate/genesis.sh
@@ -2,10 +2,33 @@
 
 # This script generates genesis files.
 # Launch it from the project root directory.
-# It will create a directory with all needed data inside. It will not 
+# It will create a directory with all needed data inside. It will not
 # copy generated genesis files into the project, this is to be done
 # manually.
 
+set -e
+
+BUILD_MODE=stack
+IOHKOPS_DIR=..
+INSTALL_TOO=
+FAKE_AVVM_ENTRIES=100
+RICHMEN_SHARE=0.94
+TESTNET_STAKE=19072918462000000
+fail() { echo "ERROR: $*" >&2; exit 1;
+}
+while test $# -ge 1; do
+case "$1" in
+        --iohkops-dir )
+                IOHKOPS_DIR="$2"; shift;;
+        --build-mode )
+                case "$2" in 'nix' ) true;; 'stack' ) true;; * ) error "--build-mode should be either 'nix' or 'stack'";; esac;
+                BUILD_MODE="$2"; shift;;
+        --install-as-suffix )
+                case "$2" in 'tns' ) true;; 'tn' ) true;; 'qanet' ) true;; * ) error "--install-as-suffix should be either 'tn', 'tns' or 'qanet'";; esac;
+                INSTALL_AS_SUFFIX="$2"; shift;;
+        "--"* ) error "unknown option: $1";;
+        * ) break;; esac; shift; done
+
 scriptsDir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"/..
 echo $scriptsDir
 outputDir="genesis-qanet-$(date +%F_%H-%M)"
@@ -20,26 +43,54 @@ mkdir $outputDir
 utxo_file=$scriptsDir/avvm-files/utxo-dump-last-new.json
 blacklisted=$scriptsDir/avvm-files/full_blacklist.js
 
-if [[ "$M" == "" ]]; then 
+if [[ "$M" == "" ]]; then
     echo "You didn't set M (rich keys amount)";
     exit 1
 fi
-if [[ "$N" == "" ]]; then 
+if [[ "$N" == "" ]]; then
     echo "You didn't set N (poor keys amount)";
     exit 1
 fi
 
-F=100 # fake avvm keys
+case "${BUILD_MODE}" in
+nix )
+        IOHKOPS_NIX=${IOHKOPS_DIR}/default.nix
+        test -f "${IOHKOPS_NIX}" ||
+                { echo "'${IOHKOPS_NIX}' doesn't exist, please supply a fitting --iohkops-dir" >&2; exit 1; }
+        KEYGEN_STOREPATH="$(nix-build --no-out-link --cores 0 --max-jobs 4 -A cardano-sl-tools-static ${IOHKOPS_NIX})"
+        test -d "${KEYGEN_STOREPATH}" ||
+                { echo "$KEYGEN_STOREPATH doesn't exist" >&2; exit 1; }
+        KEYGEN="${KEYGEN_STOREPATH}"/bin/cardano-keygen
+        test -x ${KEYGEN} ||
+                { echo "$KEYGEN doesn't exist" >&2; exit 1; }
+        keygen=${KEYGEN};;
+stack ) keygen="stack exec cardano-keygen --";;
+esac
 
 # print commit
 git show HEAD --oneline | tee $outputDir/genesisCreation.log
 
-keygenCmd="stack exec cardano-keygen -- generate-genesis --genesis-dir $outputDir -m $M -n $N --richmen-share 0.94 --testnet-stake 19072918462000000 --utxo-file $utxo_file --blacklisted $blacklisted --fake-avvm-entries $F"
+keygenCmd="${keygen} generate-genesis --genesis-dir $outputDir -m $M -n $N --richmen-share ${RICHMEN_SHARE} --testnet-stake ${TESTNET_STAKE} --utxo-file $utxo_file --blacklisted $blacklisted --fake-avvm-entries ${FAKE_AVVM_ENTRIES}"
 echo "Running command: $keygenCmd"
 $keygenCmd |& tee -a $outputDir/genesisCreation.log
 
 echo "Cleaning up"
-find $outputDir -name "*.lock" | xargs rm 
+find $outputDir -name "*.lock" | xargs rm
 
 echo "Creating archive"
 tar -czf "$outputDir.tgz" $outputDir
+
+if test -z "${INSTALL_AS_SUFFIX}"; then exit 0; fi
+echo "Installing genesis with suffix '${INSTALL_AS_SUFFIX}'"
+
+gencore="core/genesis-core-${INSTALL_AS_SUFFIX}.bin"
+gentoss="godtossing/genesis-godtossing-${INSTALL_AS_SUFFIX}.bin"
+geninfo="genesis-info/${INSTALL_AS_SUFFIX}.log"
+cp "${outputDir}"/genesis-core.bin       "${gencore}"
+cp "${outputDir}"/genesis-godtossing.bin "${gentoss}"
+cp "${outputDir}"/genesisCreation.log    "${geninfo}"
+
+echo "Genesis installed:"
+ls -l "${gencore}"
+ls -l "${gentoss}"
+ls -l "${geninfo}"
[94m[keygen:INFO:ThreadId 4] [0mProcessing command
[94m[keygen:INFO:ThreadId 4] [0mGenerating requested raw data
[94m[keygen:INFO:ThreadId 4] [0mGenerating avvm data
[94m[keygen:INFO:ThreadId 4] [0mRemoving 101 entries from utxo (out of 188 total entries in the blacklist)
[94m[keygen:INFO:ThreadId 4] [0mTotal avvm stake after applying blacklist: 25927070538000000
[94m[keygen:INFO:ThreadId 4] [0mGenerating fake avvm data into genesis-qanet-2017-08-21_11-30/keys-fakeavvm
[94m[keygen:INFO:ThreadId 4] [0m100 fake avvm seeds are generated
[94m[keygen:INFO:ThreadId 4] [0mGenerating testnet data into genesis-qanet-2017-08-21_11-30/keys-testnet
[94m[keygen:INFO:ThreadId 4] [0m1207 keyfiles are generated
[94m[keygen:INFO:ThreadId 4] [0mtestnet genesis created successfully. First 10 addresses: [PubKey address with root 279a9eff92f1d0fce6e71534b6a5dfb20f406c82ebe7572594ca86d7, attributes: AddrAttributes { stake distribution: Bootstrap era distribution, derivation path: {} }, PubKey address with root bf9ce957ef87bc24d88bb446aa4c18746cd82058c8eb8257cd2c3fef, attributes: AddrAttributes { stake distribution: Bootstrap era distribution, derivation path: {} }, PubKey address with root 80270e1ccd02cb36ef3cba769e30939c340065535f88cc7129a760b7, attributes: AddrAttributes { stake distribution: Bootstrap era distribution, derivation path: {} }, PubKey address with root 4818c84a2aea3520b8ea4861efe5646f9f895b0b6904747a53737522, attributes: AddrAttributes { stake distribution: Bootstrap era distribution, derivation path: {} }, PubKey address with root 79c989d4c7245e475a633022536b279de17477fcb68ac45f2fabcbc3, attributes: AddrAttributes { stake distribution: Bootstrap era distribution, derivation path: {} }, PubKey address with root 2d867dde1ff183fea25be081eefc6207bea78cb3b5115f0834ec38f6, attributes: AddrAttributes { stake distribution: Bootstrap era distribution, derivation path: {} }, PubKey address with root 2f04d36035f87a22f0c8b5ef47a4381023cb85a2e08af48878b7af09, attributes: AddrAttributes { stake distribution: Bootstrap era distribution, derivation path: {} }, PubKey address with root dc0855435d0a782b5b828588ca01fd16cfdad9269fa90362d435b09f, attributes: AddrAttributes { stake distribution: Bootstrap era distribution, derivation path: {} }, PubKey address with root 74744995256aec3d5b430e251352ca1b8c5f7df85fdbf51e02090965, attributes: AddrAttributes { stake distribution: Bootstrap era distribution, derivation path: {} }, PubKey address with root a8a9ad9bee941fa025e10dbe6040b0ccb5b34bcad100e4cc2cf7f556, attributes: AddrAttributes { stake distribution: Bootstrap era distribution, derivation path: {} }] distr: RichPoorStakes {sdRichmen = 7, sdRichStake = Coin {getCoin = 2561220479182857}, sdPoor = 2400, sdPoorStake = Coin {getCoin = 476822961550}}
[94m[keygen:INFO:ThreadId 4] [0mgenesis-core.bin generated successfully
[94m[keygen:INFO:ThreadId 4] [0mgenesis-godtossing.bin generated successfully
